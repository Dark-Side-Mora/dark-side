// ============================================
// Learning Course Modules
// ============================================

model CourseModule {
  id        Int      @id @default(autoincrement())
  title     String
  status    String   // 'Completed', 'In Progress', 'Not Started'
  length    String   // e.g. '15 mins'
  icon      String   // e.g. 'ðŸŽ¯'
  order     Int      // For ordering modules in UI
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  quizzes   Quiz[]

  @@unique([title])
  @@index([order])
}
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id         String   @id // Supabase User ID (UUID)
  email      String   @unique
  fullName   String?
  bio        String?
  avatar     String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  organizationMemberships OrganizationMembership[]
  membershipRequests MembershipRequest[]
}

model Project {
  id            String     @id @default(uuid())
  name          String
  provider      String     // 'github', 'gitlab', etc.
  repositoryUrl String
  pipelines     Pipeline[]
  userId        String     // Supabase Auth User ID
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  githubRepositories GitHubRepository[] // If provider is 'github', link to GitHubRepository
  // For future: gitlabRepositories GitLabRepository[]
  createdAt     DateTime   @default(now())
}

model Pipeline {
  id               String            @id @default(uuid())
  projectId        String
  project          Project           @relation(fields: [projectId], references: [id])
  externalId       String            // CI Provider's ID
  status           String
  branch           String?
  commitSha        String?
  eventType        String?           // push, pull_request
  startedAt        DateTime?
  finishedAt       DateTime?
  createdAt        DateTime          @default(now())
  jobs             Job[]
  securityFindings SecurityFinding[]
}

model Job {
  id         String    @id @default(uuid())
  pipelineId String
  pipeline   Pipeline  @relation(fields: [pipelineId], references: [id])
  name       String
  status     String
  stage      String?
  startedAt  DateTime?
  finishedAt DateTime?
}

model SecurityFinding {
  id          String   @id @default(uuid())
  pipelineId  String
  pipeline    Pipeline @relation(fields: [pipelineId], references: [id])
  severity    String   
  type        String
  description String?
  remediation String?
  filePath    String?
}

model IntegrationConnection {
  id                String                @id @default(uuid())
  userId            String                // Supabase Auth User ID
  provider          String                // 'github', 'jenkins', etc.
  accessToken       String                // Encrypted token
  refreshToken      String?               // Optional refresh token
  expiresAt         DateTime?
  metadata          Json?                 // Provider-specific metadata
  status            String                @default("active") // active, expired, revoked
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  organizationAccess OrganizationAccess[]
  githubInstallations GitHubInstallation[]

  @@unique([userId, provider])
  @@index([userId])
}

model OrganizationAccess {
  id                     String               @id @default(uuid())
  connectionId           String
  connection             IntegrationConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  organizationId         String               // GitHub org ID
  organizationName       String               // GitHub org name/login
  repositoryPermissions  Json                 // Array of allowed repos: [{id, name, fullName}]
  lastSyncedAt           DateTime             @default(now())
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  @@unique([connectionId, organizationId])
  @@index([connectionId])
}

model GitHubInstallation {
  id                  String                @id @default(uuid())
  userId              String                // Supabase Auth User ID
  connectionId        String?
  connection          IntegrationConnection? @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  installationId      String                @unique // GitHub App installation ID
  accountId           String                // GitHub account/org ID
  accountLogin        String                // GitHub account/org login
  accountType         String                // 'User' or 'Organization'
  targetType          String                // 'User' or 'Organization'
  permissions         Json                  // Installation permissions
  repositorySelection String                // 'all' or 'selected'
  repositories        GitHubRepository[]
  status              String                @default("active") // active, suspended, removed
  installedAt         DateTime              @default(now())
  updatedAt           DateTime              @updatedAt

  @@index([userId])
  @@index([installationId])
  @@index([accountId])
}

model GitHubRepository {
  id             String             @id @default(uuid())
  installationId String
  installation   GitHubInstallation @relation(fields: [installationId], references: [id], onDelete: Cascade)
  projectId      String?
  project        Project?           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  repositoryId   String             // GitHub repo ID
  name           String             // Repo name
  fullName       String             // owner/repo
  private        Boolean
  permissions    Json?              // Specific permissions for this repo
  addedAt        DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  @@unique([installationId, repositoryId])
  @@index([installationId])
  @@index([repositoryId])
  @@index([projectId])
}

model WorkflowAnalysisCache {
  id                    String             @id @default(uuid())
  userId                String
  repositoryId          String
  workflowPath          String
  workflowName          String
  workflowFileContent   String             @db.Text
  latestRunLogs         String             @db.Text
  contentHash           String

  analysisId            String             @unique
  aiProvider            String
  overallRisk           String
  summary               String             @db.Text
  issues                Json

  analysisTimestamp     DateTime
  cachedAt              DateTime           @default(now())
  expiresAt             DateTime

  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  @@unique([repositoryId, contentHash])
  @@index([userId])
  @@index([repositoryId])
  @@index([workflowPath])
  @@index([expiresAt])
}

// ============================================
// Learning Platform Models (Simplified)
// ============================================

model Quiz {
  id            Int      @id @default(autoincrement())
  name          String
  description   String   @db.Text
  difficulty    String   // 'beginner', 'intermediate', 'advanced'
  courseModule  CourseModule @relation(fields: [courseModuleId], references: [id], onDelete: Cascade)
  courseModuleId Int
  questions     QuizQuestion[]
}

model QuizQuestion {
  id            Int      @id @default(autoincrement())
  quiz          Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId        Int
  type          String   // 'multiple-choice', 'workflow-fix'
  question      String   @db.Text
  choices       String[] // For multiple choice and workflow-fix (as options)
  correctIndex  Int      // Index in choices array (for both types)
  points        Int      // Points for this question
  workflowCode  String?  @db.Text // For workflow-fix type
  hint          String?  @db.Text

  userProgress  UserQuizProgress[]
}

model UserQuizProgress {
  id         Int    @id @default(autoincrement())
  userId     String // Supabase Auth User ID
  question   QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  questionId Int
  mark       Int
  // Add timestamp if needed
}

// ============================================
// Organization Management Models
// ============================================

model Organization {
  id        String   @id @default(uuid())
  name      String
  domain    String
  members   OrganizationMembership[]
  requests  MembershipRequest[]
  projects  Project[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([domain])
}

model OrganizationMembership {
  id             String   @id @default(uuid())
  organizationId String
  userId         String
  role           String   // 'owner', 'admin', 'member'
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model MembershipRequest {
  id             String   @id @default(uuid())
  organizationId String
  userId         String
  status         String   // 'Comming Soon', 'Available', 'Paused'
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}
